<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappy WebSocket Test Client (Single Port)</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 10px;
        }
        .connected { background-color: #4CAF50; color: white; }
        .disconnected { background-color: #f44336; color: white; }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .events {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .event-line {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .event-info { background-color: #e7f3ff; }
        .event-success { background-color: #e8f5e8; }
        .event-warning { background-color: #fff3cd; }
        .event-error { background-color: #f8d7da; }
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎮 Zappy WebSocket Test Client</h1>
            <p>Testing WebSocket API on the same port as REST API</p>
            <div>
                Connection Status: <span id="status" class="status disconnected">Disconnected</span>
            </div>
        </div>

        <div class="info-box">
            <strong>🔗 Single Port Architecture:</strong><br>
            • REST API: <code>http://localhost:5000/api/</code><br>
            • WebSocket: <code>ws://localhost:5000/ws</code><br>
            • Both APIs on the same port with different endpoints!
        </div>

        <div class="section">
            <h3>🔌 Connection Control</h3>
            <div class="controls">
                <button id="connectBtn" class="btn-success" onclick="connectToServer()">Connect to Server</button>
                <button id="disconnectBtn" class="btn-danger" onclick="disconnectFromServer()">Disconnect</button>
                <button class="btn-info" onclick="getCurrentState()">Get Current State</button>
                <button class="btn-warning" onclick="clearEvents()">Clear Events</button>
            </div>
        </div>

        <div class="section">
            <h3>📡 Event Subscriptions</h3>
            <div class="controls">
                <button class="btn-primary" onclick="subscribeToEvents(['player_updates'])">Subscribe to Players</button>
                <button class="btn-primary" onclick="subscribeToEvents(['server_updates'])">Subscribe to Server</button>
                <button class="btn-primary" onclick="subscribeToEvents(['map_updates'])">Subscribe to Map</button>
                <button class="btn-primary" onclick="subscribeToEvents(['team_updates'])">Subscribe to Teams</button>
                <button class="btn-primary" onclick="subscribeToEvents(['all_events'])">Subscribe to All</button>
                <button class="btn-warning" onclick="unsubscribeFromAll()">Unsubscribe All</button>
            </div>
        </div>

        <div class="section">
            <h3>🎮 Server Commands</h3>
            <div class="controls">
                <button class="btn-success" onclick="stepServer()">Step Server</button>
                <button class="btn-info" onclick="updatePlayer()">Update Player Level</button>
                <button class="btn-info" onclick="updateTile()">Update Map Tile</button>
                <button class="btn-warning" onclick="killPlayer()">Kill Player</button>
            </div>
            
            <div class="input-group">
                <label>Custom Command:</label>
                <select id="commandType">
                    <option value="step">Step Server</option>
                    <option value="update_player">Update Player</option>
                    <option value="update_tile">Update Tile</option>
                </select>
                <button class="btn-primary" onclick="executeCustomCommand()">Execute</button>
            </div>
        </div>

        <div class="section">
            <h3>📊 Real-time Events</h3>
            <div id="events" class="events">Waiting for connection...\n</div>
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;
        let clientId = null;

        function addEvent(message, type = 'info') {
            const eventsDiv = document.getElementById('events');
            const timestamp = new Date().toLocaleTimeString();
            const eventLine = document.createElement('div');
            eventLine.className = `event-line event-${type}`;
            eventLine.textContent = `[${timestamp}] ${message}`;
            eventsDiv.appendChild(eventLine);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }

        function updateStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                clientId = null;
            }
        }

        function connectToServer() {
            if (socket) {
                socket.disconnect();
            }

            // Connect to WebSocket on same port but different path
            socket = io('http://localhost:5000', {
                path: '/ws',  // Custom path for WebSocket
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                addEvent('🟢 Connected to WebSocket server', 'success');
                updateStatus(true);
            });

            socket.on('disconnect', () => {
                addEvent('🔴 Disconnected from WebSocket server', 'error');
                updateStatus(false);
            });

            socket.on('connected', (data) => {
                clientId = data.client_id;
                const serverInfo = data.server_info;
                addEvent(`✅ Connection confirmed! Client ID: ${clientId}`, 'success');
                addEvent(`📊 Server: ${serverInfo.ticks} ticks, ${serverInfo.players} players, Map: ${serverInfo.map_size}x${serverInfo.map_size}`, 'info');
                addEvent(`📡 Available subscriptions: ${data.available_subscriptions.join(', ')}`, 'info');
            });

            socket.on('subscribed', (data) => {
                addEvent(`📡 Subscribed to: ${data.events.join(', ')}`, 'success');
            });

            socket.on('unsubscribed', (data) => {
                addEvent(`📡 Unsubscribed from: ${data.events.join(', ')}`, 'warning');
            });

            socket.on('player_updates', (data) => {
                if (data.type === 'property_changed') {
                    addEvent(`👤 Player ${data.player_id} ${data.property}: ${data.old_value} → ${data.new_value}`, 'info');
                } else if (data.type === 'player_died') {
                    addEvent(`💀 Player died: ${data.player.id} (Team: ${data.player.team})`, 'warning');
                }
            });

            socket.on('server_updates', (data) => {
                if (data.type === 'step_end') {
                    addEvent(`🖥️ Server Tick: ${data.ticks} (Players alive: ${data.stats.alive_players || '?'})`, 'info');
                }
            });

            socket.on('map_updates', (data) => {
                if (data.type === 'tile_changed') {
                    const pos = data.position;
                    addEvent(`🗺️ Tile (${pos[0]},${pos[1]}) ${data.resource}: ${data.old_amount} → ${data.new_amount}`, 'info');
                }
            });

            socket.on('team_updates', (data) => {
                if (data.type === 'team_added') {
                    addEvent(`👥 Team Added: ${data.team}`, 'success');
                } else if (data.type === 'team_removed') {
                    addEvent(`👥 Team Removed: ${data.team}`, 'warning');
                }
            });

            socket.on('event', (data) => {
                addEvent(`📡 Generic Event [${data.type}]: ${JSON.stringify(data.data)}`, 'info');
            });

            socket.on('current_state', (data) => {
                if (data.success) {
                    const state = data.data;
                    addEvent(`📊 Current State: ${state.ticks} ticks, ${state.teams.length} teams, ${state.players.length} players`, 'success');
                } else {
                    addEvent(`❌ Failed to get state: ${data.error}`, 'error');
                }
            });

            socket.on('command_result', (data) => {
                if (data.success) {
                    addEvent(`✅ Command '${data.command}': ${data.result}`, 'success');
                } else {
                    addEvent(`❌ Command '${data.command}' failed: ${data.error}`, 'error');
                }
            });

            socket.on('error', (data) => {
                addEvent(`❌ Error: ${data.message}`, 'error');
            });

            addEvent('🔄 Connecting to WebSocket server...', 'info');
        }

        function disconnectFromServer() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            updateStatus(false);
        }

        function subscribeToEvents(events) {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            socket.emit('subscribe', { events: events });
        }

        function unsubscribeFromAll() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            const allEvents = ['player_updates', 'server_updates', 'map_updates', 'team_updates', 'all_events'];
            socket.emit('unsubscribe', { events: allEvents });
        }

        function getCurrentState() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            socket.emit('get_current_state');
        }

        function stepServer() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            socket.emit('server_command', { command: 'step' });
        }

        function updatePlayer() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            const randomLevel = Math.floor(Math.random() * 10) + 1;
            socket.emit('server_command', {
                command: 'update_player',
                params: { player_id: 0, property: 'level', value: randomLevel }
            });
        }

        function updateTile() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            const x = Math.floor(Math.random() * 10);
            const y = Math.floor(Math.random() * 10);
            const amount = Math.floor(Math.random() * 50) + 1;
            socket.emit('server_command', {
                command: 'update_tile',
                params: { x: x, y: y, resource: 'food', amount: amount }
            });
        }

        function killPlayer() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            socket.emit('server_command', {
                command: 'update_player',
                params: { player_id: 0, property: 'is_alive', value: false }
            });
        }

        function executeCustomCommand() {
            if (!isConnected) {
                addEvent('❌ Not connected to server', 'error');
                return;
            }
            const commandType = document.getElementById('commandType').value;
            
            let params = {};
            if (commandType === 'update_player') {
                params = { player_id: 0, property: 'level', value: Math.floor(Math.random() * 10) + 1 };
            } else if (commandType === 'update_tile') {
                params = { x: 5, y: 5, resource: 'linemate', amount: Math.floor(Math.random() * 20) + 1 };
            }
            
            socket.emit('server_command', { command: commandType, params: params });
        }

        function clearEvents() {
            document.getElementById('events').innerHTML = '';
        }

        // Initialize page
        updateStatus(false);
        addEvent('🎮 Zappy WebSocket Test Client Ready', 'success');
        addEvent('📍 Server URL: ws://localhost:5000/ws', 'info');
        addEvent('🔗 Click "Connect to Server" to start testing', 'info');
    </script>
</body>
</html>
